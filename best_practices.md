# üìò Project Best Practices

## 1. Project Purpose
–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–π Telegram-–±–æ—Ç ¬´–°–∏–∫–°–∏–∫¬ª –Ω–∞ Python 3.12, –∏—Å–ø–æ–ª—å–∑—É—é—â–∏–π Pollinations.AI –¥–ª—è:
- –¥–∏–∞–ª–æ–≥–æ–≤–æ–≥–æ AI-—á–∞—Ç–∞ —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
- —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏ –≥–æ–ª–æ—Å–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (FFmpeg + Pollinations audio)
- –∞–Ω–∞–ª–∏–∑–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π (vision)
- –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –ø–æ —Ç–µ–∫—Å—Ç–æ–≤–æ–º—É –æ–ø–∏—Å–∞–Ω–∏—é
–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –∏ –≥—Ä—É–ø–ø–æ–≤—ã–µ —á–∞—Ç—ã, —Ä–æ–ª–∏/–ø–µ—Ä—Å–æ–Ω—ã, –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —á–∞—Å—Ç–æ—Ç—ã –∑–∞–ø—Ä–æ—Å–æ–≤ –∏ —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ.

## 2. Project Structure
- run.py ‚Äî —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞ (—Å–æ–∑–¥–∞–µ—Ç –∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç event loop, –≤—ã–∑—ã–≤–∞–µ—Ç bot.main.run_bot)
- src/
  - bot/
    - main.py ‚Äî –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Application, –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è, —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Ö–µ–Ω–¥–ª–µ—Ä–æ–≤, –∑–∞–ø—É—Å–∫ polling
    - handlers/
      - commands.py ‚Äî –∫–æ–º–∞–Ω–¥—ã (/start, /help, /reset, /prompt, /setprompt, /resetprompt, /roles, /contextlimit, /setcontextlimit, /updatecmds, /imagine)
      - messages.py ‚Äî –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Ç–µ–∫—Å—Ç–æ–≤, –≥–æ–ª–æ—Å–æ–≤—ã—Ö –∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
      - callbacks.py ‚Äî –æ–±—Ä–∞–±–æ—Ç–∫–∞ callback_data –¥–ª—è —Ä–æ–ª–µ–π –∏ –ø–µ—Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
      - errors.py ‚Äî —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π error handler —É—Ä–æ–≤–Ω—è telegram-–±–æ—Ç–∞
  - config/
    - settings.py ‚Äî Pydantic v2 –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (env, –≤–∞–ª–∏–¥–∞—Ü–∏—è, –¥–µ—Ñ–æ–ª—Ç—ã)
  - services/
    - context_manager.py ‚Äî —Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–≤, –ø—Ä–æ–º–ø—Ç–æ–≤, —Ä–æ–ª–µ–π, –ª–∏–º–∏—Ç–æ–≤, —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏, —Ñ–ª–∞–≥–æ–≤ ¬´–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏¬ª
    - pollinations_service.py ‚Äî –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Pollinations API (chat, audio, vision, image)
  - utils/
    - telegram_utils.py ‚Äî —É—Ç–∏–ª–∏—Ç—ã: ¬´–ø–µ—á–∞—Ç–∞–µ—Ç‚Ä¶¬ª, —Ä–∞–∑–±–∏–µ–Ω–∏–µ –¥–ª–∏–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π, —É–¥–∞–ª–µ–Ω–∏–µ —Ä–µ–∫–ª–∞–º–Ω—ã—Ö –±–ª–æ–∫–æ–≤
    - error_handler.py ‚Äî –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –∫–ª–∞—Å—Å—ã/—É—Ç–∏–ª–∏—Ç—ã –¥–ª—è –æ—à–∏–±–æ–∫ (–Ω–µ–ø–æ—Å—Ä–µ–¥—Å—Ç–≤–µ–Ω–Ω–æ –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω –∫–∞–∫ handler)
- docker/
  - Dockerfile, docker-compose.yml ‚Äî —Å–±–æ—Ä–∫–∞/–∑–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (ffmpeg –ø—Ä–µ–¥—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω)
- tests/ ‚Äî –∫–∞—Ç–∞–ª–æ–≥ –ø–æ–¥ —Ç–µ—ÅÔøΩÔøΩ—ã (–Ω–∞ —Ç–µ–∫—É—â–∏–π –º–æ–º–µ–Ω—Ç –ø—É—Å—Ç–æ–π)
- requirements.txt ‚Äî –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
- .env.example / .env ‚Äî –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –æ–∫—Ä—É–∂–µ–Ω–∏—è
- logs/ ‚Äî —Ñ–∞–π–ª—ã –ª–æ–≥–æ–≤

–†–æ–ª–∏ –∫–ª—é—á–µ–≤—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤:
- Settings (config/settings.py): –∑–∞–≥—Ä—É–∑–∫–∞ .env, —Å—Ç—Ä–æ–≥–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –∫–ª—é—á–µ–≤—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤, –µ–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –ø—Ä–∞–≤–¥—ã –¥–ª—è –∫–æ–Ω—Ñ–∏–≥–æ–≤
- ContextManager: —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º –¥–∏–∞–ª–æ–≥–∞, —Ä–æ–ª—è–º–∏/–ø–µ—Ä—Å–æ–Ω–∞–º–∏, —Å–∏—Å—Ç–µ–º–Ω—ã–º –ø—Ä–æ–º–ø—Ç–æ–º, –ª–∏–º–∏—Ç–∞–º–∏, —Ñ–ª–∞–≥–∞–º–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏, —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π
- Handlers: —á–µ—Ç–∫–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –ø–æ —Ç–∏–ø–∞–º (–∫–æ–º–∞–Ω–¥—ã, —Å–æ–æ–±—â–µ–Ω–∏—è, –∫–æ–ª–ª–±–µ–∫–∏, –æ—à–∏–±–∫–∏)
- Services: –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –≤–Ω–µ—à–Ω–∏–º–∏ API (Pollinations), –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ/–æ—Ç–ø—Ä–∞–≤–∫–∞ –º–µ–¥–∏–∞, —Å–µ—Ç–µ–≤—ã–µ –≤—ã–∑–æ–≤—ã
- Utils: –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã–µ —É—Ç–∏–ª–∏—Ç—ã –¥–ª—è Telegram –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ç–µ–∫—Å—Ç–∞

## 3. Test Strategy
–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ: –∫–∞—Ç–∞–ª–æ–≥ tests/ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç, –Ω–æ —Ç–µ—Å—Ç—ã –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç. –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π –ø–æ–¥—Ö–æ–¥:
- –§—Ä–µ–π–º–≤–æ—Ä–∫: pytest + pytest-asyncio
- –°—Ç—Ä—É–∫—Ç—É—Ä–∞:
  - tests/unit/test_context_manager.py ‚Äî –øÔøΩÔøΩ–≤–µ–¥–µ–Ω–∏–µ ContextManager (–ª–∏–º–∏—Ç—ã, —Ä–æ–ª–∏, —Å–±–æ—Ä–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è API)
  - tests/unit/test_pollinations_service.py ‚Äî –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ –º–µ–¥–∏–∞, —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ payload, —Ä–∞–∑–±–æ—Ä –æ—Ç–≤–µ—Ç–æ–≤, –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
  - tests/unit/test_telegram_utils.py ‚Äî —Ä–∞–∑–±–∏–µ–Ω–∏–µ –¥–ª–∏–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π, —É–¥–∞–ª–µ–Ω–∏–µ —Ä–µ–∫–ª–∞–º—ã, show_typing (—Å —Ç–∞–π–º–∞—É—Ç–∞–º–∏)
  - tests/integration/test_handlers_messages.py ‚Äî —Å—Ü–µ–Ω–∞—Ä–∏–∏: —É–ø–æ–º–∏–Ω–∞–Ω–∏—è –≤ –≥—Ä—É–ø–ø–∞—Ö, –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–æ–≤, –æ—à–∏–±–∫–∏ API (–º–æ–∫–∏)
  - tests/integration/test_handlers_commands.py ‚Äî —Å–º–µ–Ω–∞ —Ä–æ–ª–µ–π, –ª–∏–º–∏—Ç–æ–≤, –ø—Ä–æ–º–ø—Ç–æ–≤; imagine –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
- –ú–æ–∫–∏–Ω–≥:
  - –ú–æ–∫–∞—Ç—å HTTP-–≤—ã–∑–æ–≤—ã (requests) –∏ Pollinations API-–æ–±–µ—Ä—Ç–∫–∏
  - –ú–æ–∫–∞—Ç—å context.bot.* –º–µ—Ç–æ–¥—ã (send_message, send_photo, edit_message_text, delete_message)
  - –î–ª—è FFmpeg ‚Äî –º–æ–∫–∞—Ç—å subprocess.run
- –§–∏–ª–æ—Å–æ—Ñ–∏—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:
  - –Æ–Ω–∏—Ç-—Ç–µ—Å—Ç—ã –¥–ª—è —á–∏—Å—Ç–æ–π –ª–æ–≥–∏–∫–∏ (ContextManager, utils, —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ payload)
  - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã –¥–ª—è —Ö–µ–Ω–¥–ª–µ—Ä–æ–≤ —Å —Ñ–µ–π–∫–æ–≤—ã–º–∏ Update/Context
  - –ü–æ–∫—Ä—ã–≤–∞—Ç—å –≤–µ—Ç–∫–∏ –æ—à–∏–±–æ–∫ –∏ —Ç–∞–π–º–∞—É—Ç–æ–≤
  - –¶–µ–ª—å –ø–æ–∫ÔøΩÔøΩ—ã—Ç–∏—è: 70%+ –Ω–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –º–æ–¥—É–ª—è—Ö (services, context)

## 4. Code Style
- –Ø–∑—ã–∫/Async:
  - python-telegram-bot v20 ‚Äî –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å async def –¥–ª—è —Ö–µ–Ω–¥–ª–µ—Ä–æ–≤, –Ω–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å event loop
  - –î–ª—è —Å–µ—Ç–µ–≤—ã—Ö/CPU-–±–ª–æ–∫–∏—Ä—É—é—â–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å asyncio.to_thread –∏–ª–∏ –≤–Ω–µ—à–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å—ã (FFmpeg)
- –¢–∏–ø–∏–∑–∞—Ü–∏—è:
  - –î–æ–±–∞–≤–ª—è—Ç—å —è–≤–Ω—ã–µ —Ç–∏–ø—ã –≤ –ø—É–±–ª–∏—á–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∏ –º–µ—Ç–æ–¥—ã, –æ—Å–æ–±–µ–Ω–Ω–æ –≤ services –∏ context
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:
  - –ï–¥–∏–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è logging –≤ bot/main.py (StreamHandler + FileHandler logs/bot.log)
  - –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –∫–ª—é—á–µ–≤—ã–µ —Å–æ–±—ã—Ç–∏—è (—Å—Ç–∞—Ä—Ç/—Å—Ç–æ–ø, –∫–æ–º–∞–Ω–¥—ã, –æ—à–∏–±–∫–∏, —Ç–∞–π–º–∞—É—Ç—ã)
- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:
  - –í—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã ‚Äî —á–µ—Ä–µ–∑ Settings (Pydantic v2). –î–ª—è –Ω–æ–≤—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –¥–æ–±–∞–≤–ª—è—Ç—å –≤–∞–ª–∏–¥–∞—Ç–æ—Ä—ã
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫:
  - try/except –≤–æ–∫—Ä—É–≥ –≤–Ω–µ—à–Ω–∏—Ö –≤—ã–∑–æ–≤–æ–≤; –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å –ø–æ–Ω—è—Ç–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —Å–æ–æ–±—â–µ–Ω–∏—è
  - –í error_handler (bot/handlers/errors.py) –æ—Ç–≤–µ—á–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –∏ –¥–æ–±–∞–≤–ª—è—Ç—å message_id –≤ cleanup –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è
- Telegram-–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:
  - –î–ª–∏–Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–π: –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å utils.send_long_message –ø—Ä–∏ > 4000 —Å–∏–º–≤–æ–ª–æ–≤
  - Markdown: –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é ParseMode.MARKDOWN; –∏–∑–±–µ–≥–∞—Ç—å —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ V2, –µ—Å–ª–∏ –Ω–µ –≤–∫–ª—é—á–µ–Ω
  - callback_data <= 64 –±–∞–π—Ç ‚Äî –¥–µ—Ä–∂–∞—Ç—å —Ñ–æ—Ä–º–∞—Ç –∫–æ–ª–ª–±–µ–∫–æ–≤ –∫–æ–º–ø–∞–∫—Ç–Ω—ã–º (—Å–º. imagine::WxH)
- –ì—Ä—É–ø–ø—ã –∏ —É–ø–æ–º–∏–Ω–∞–Ω–∏—è:
  - –í –≥—Ä—É–ø–ø–∞—Ö —Ä–µ–∞–≥–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —É–ø–æ–º–∏–Ω–∞–Ω–∏–∏ –±–æ—Ç–∞ –∏–ª–∏ –≤ –æ—Ç–≤–µ—Ç–µ –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ –±–æ—Ç–∞
  - –°–æ–æ–±—â–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–∞–∂–µ –±–µ–∑ –æ—Ç–≤–µ—Ç–∞ (–¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏)
- –†–µ–∫–ª–∞–º–∞:
  - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å utils.strip_advertisement –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ —Ä–µ–∫–ª–∞–º–Ω—ã—Ö –±–ª–æ–∫–æ–≤ –∏–∑ AI-–æ—Ç–≤–µ—Ç–æ–≤
- –ö–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω—ã–π –¥–æ—Å—Ç—É–ø:
  - –ü–µ—Ä–µ–¥ –¥–ª–∏—Ç–µ–ª—å–Ω—ã–º–∏ –∑–∞–¥–∞—á–∞–º–∏ –≤—ã—Å—Ç–∞–≤–ª—è—Ç—å context_manager.set_generating(chat_id, True), —Å–Ω–∏–º–∞—Ç—å –≤ finally
  - Rate limiting ‚Äî —á–µ—Ä–µ–∑ context_manager.check_rate_limit(user_id, ...)

## 5. Common Patterns
- –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Ö–µ–Ω–¥–ª–µ—Ä–æ–≤ (bot/main.py):
  - –ö–æ–º–∞–Ω–¥—ã –∏ CallbackQueryHandler ‚Äî group=0 (–≤—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)
  - –°–æ–æ–±—â–µ–Ω–∏—è ‚Äî group=2 (–Ω–∏–∂–µ –ø—Ä–∏–æ—Ä–∏ÔøΩÔøΩ–µ—Ç)
  - error_handler ‚Äî —á–µ—Ä–µ–∑ application.add_error_handler
- –§–æ—Ä–º–∞—Ç callback_data:
  - role::<key> ‚Äî –≤—ã–±–æ—Ä —Ä–æ–ª–∏
  - imagine::WxH ‚Äî –ø–µ—Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞
- ContextManager:
  - add_message(chat_id, role, content, author)
  - build_api_messages(chat_id) ‚Äî –≤–∫–ª—é—á–∞–µ—Ç system prompt –∏ –∞–≤—Ç–æ—Ä–∞ –≤ user-—Å–æ–æ–±—â–µ–Ω–∏—è—Ö
  - add_image_context(chat_id, analysis) ‚Äî –¥–æ–±–∞–≤–ª—è–µ—Ç —Å–∏—Å—Ç–µ–º–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∞–Ω–∞–ª–∏–∑–æ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
  - get/set_context_limit, set_role, set/reset_system_prompt, is_generating
- –°–µ—Ç–µ–≤—ã–µ –≤—ã–∑–æ–≤—ã:
  - services.pollinations_service: –≤—Å–µ HTTP —á–µ—Ä–µ–∑ requests —Å —Ç–∞–π–º–∞—É—Ç–∞–º–∏ –∏ —Ä–∞–∑–±–æ—Ä–æ–º –æ—à–∏–±–æ–∫
  - –î–ª–∏—Ç–µ–ª—å–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ ‚Äî —á–µ—Ä–µ–∑ asyncio.to_thread
- –ú–µ–¥–∏–∞ –∏ —Ñ–∞–π–ª—ã:
  - –ì–æ–ª–æ—Å: —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ -> FFmpeg –∫–æ–Ω–≤–µ—Ä—Å–∏—è –≤ WAV 16kHz mono -> —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è
  - –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ -> base64 -> vision API
  - –£–¥–∞–ª—è—Ç—å –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã (shutil.rmtree) –≤ finally/try
- –°–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é:
  - –ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ —Å—Ç–∞—Ç—É—Å—ã ("–î—É–º–∞—é...", "–¢—Ä–∞–Ω—Å–∫—Ä–∏–±–∏—Ä—É—é‚Ä¶", "–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é‚Ä¶")
  - –ü–æ —É—Å–ø–µ—à–Ω–æ–º –æ—Ç–≤–µ—Ç–µ ‚Äî –æ—á–∏—â–∞—Ç—å –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω—ã–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è (consume_cleanup_messages)

## 6. Do's and Don'ts
- ‚úÖ –î–µ–ª–∞—Ç—å
  - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Settings –¥–ª—è –≤—Å–µ—Ö –Ω–æ–≤—ã—Ö –∫–æ–Ω—Ñ–∏–≥–æ–≤, –¥–æ–±–∞–≤–ª—è—Ç—å –≤ .env.example
  - –û–±–æ—Ä–∞—á–∏–≤–∞—Ç—å –≤–Ω–µ—à–Ω–∏–µ –≤—ã–∑–æ–≤—ã –≤ try/except, –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å –∏ –æ—Ç–≤–µ—á–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
  - –•—Ä–∞–Ω–∏—Ç—å –∏ —É–≤–∞–∂–∞—Ç—å —Ñ–ª–∞–≥ is_generating, —á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–≥—Ä—É–∂–∞—Ç—å —á–∞—Ç
  - –†–∞–∑–±–∏–≤–∞—Ç—å –¥–ª–∏–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã send_long_message
  - –ü—Ä–æ–≤–µ—Ä—è—Ç—å —Ä–∞–∑–º–µ—Ä—ã –º–µ–¥–∏–∞-—Ñ–∞–π–ª–æ–≤ –ø—Ä–æ—Ç–∏–≤ –Ω–∞—Å—Ç—Ä–æ–µ–∫ (max_voice_size_mb, max_image_size_mb)
  - –ü–∏—Å–∞—Ç—å –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ —Ö–µ–Ω–¥–ª–µ—Ä—ã –∏ –∏–∑–±–µ–≥–∞—Ç—å –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫ event loop
  - –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å —Ä—É—Å—Å–∫–∏–π —Ç–µ–∫—Å—Ç UI –∏ —ç–º–æ–¥–∑–∏-—Å–ø–∏—Å–æ–∫ –∫–æ–º–∞–Ω–¥
- ‚ùå –ù–µ –¥–µ–ª–∞—Ç—å
  - –ù–µ –≤—ã–ø–æ–ª–Ω—è—Ç—å –±–ª–æ–∫–∏—Ä—É—é—â–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤ —Ö–µ–Ω–¥–ª–µ—Ä–∞—Ö –±–µ–∑ asyncio.to_thread
  - –ù–µ –ø—Ä–µ–≤—ã—à–∞—Ç—å –ª–∏–º–∏—Ç—ã Telegram (–¥–ª–∏–Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–π, callback_data)
  - –ù–µ —Å–º–µ—à–∏–≤–∞—Ç—å –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É –∏ Telegram-—Å–ø–µ—Ü–∏—Ñ–∏–∫—É –≤ services ‚Äî –¥–µ—Ä–∂–∞—Ç—å –∞–¥–∞–ø—Ç–µ—Ä—ã —á–∏—Å—Ç—ã–º–∏
  - –ù–µ —Ö–∞—Ä–¥–∫–æ–¥–∏—Ç—å —Å–µ–∫—Ä–µ—ÇÔøΩÔøΩ ‚Äî —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ .env / Settings

## 7. Tools & Dependencies
- –ë–∏–±–ª–∏–æ—Ç–µ–∫–∏:
  - python-telegram-bot==20.6 ‚Äî Telegram API (asyncio)
  - requests ‚Äî HTTP –≤—ã–∑–æ–≤—ã –∫ Pollinations
  - pydantic v2 + pydantic-settings ‚Äî –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è
  - python-dotenv ‚Äî –ø–æ–¥–¥–µ—Ä–∂–∫–∞ .env –∑–∞–≥—Ä—É–∑–∫–∏ (—á–µ—Ä–µ–∑ pydantic-settings)
  - aiofiles ‚Äî –∑–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–æ/–≤–æ–∑–º–æ–∂–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –¥–ª—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π —Ä–∞–±–æ—Ç—ã —Å —Ñ–∞–π–ª–∞–º–∏
- –°–∏—Å—Ç–µ–º–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:
  - FFmpeg ‚Äî –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω –¥–ª—è –≥–æ–ª–æ—Å–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (–∫–æ–Ω–≤–µ—Ä—Å–∏—è OGG -> WAV)
- –ó–∞–ø—É—Å–∫:
  - –õ–æ–∫–∞–ª—å–Ω–æ: python run.py (–ø—Ä–∏ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–Ω–æ–º venv –∏ –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω–æ–º .env)
  - Docker: docker build -t telegram-bot . && docker run --env-file .env -v ./logs:/app/logs telegram-bot
  - Compose: docker-compose up -d
- –ó–∞–º–µ—á–∞–Ω–∏–µ –ø–æ Docker healthcheck:
  - –í Dockerfile/docker-compose –∑–∞–¥–∞–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ http://localhost:8080/health, –Ω–æ HTTP-—Å–µ—Ä–≤–∏—Å –Ω–µ –ø–æ–¥–Ω–∏–º–∞–µ—Ç—Å—è –±–æ—Ç–æ–º. –õ–∏–±–æ –æ—Ç–∫–ª—é—á–∏—Ç–µ healthcheck, –ª–∏–±–æ —Ä–µ–∞–ª–∏–∑—É–π—Ç–µ –ª—ë–≥–∫–∏–π HTTP-—ç–Ω–¥–ø–æ–∏–Ω—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä, —á–µ—Ä–µ–∑ aiohttp) –∏ –ø—Ä–æ–±—Ä–æ—Å –ø–æ—Ä—Ç–∞.

## 8. Other Notes
- –î–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤—ã—Ö –∫–æ–º–∞–Ω–¥/—Ä–æ–ª–µ–π:
  - –•–µ–Ω–¥–ª–µ—Ä—ã ‚Äî –≤ bot/handlers; —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é ‚Äî –≤ bot/main.setup_handlers
  - –û–±–Ω–æ–≤–∏—Ç—å –º–µ–Ω—é –∫–æ–º–∞–Ω–¥ —á–µ—Ä–µ–∑ set_bot_commands –∏ /updatecmds
  - –ù–æ–≤—ã–µ —Ä–æ–ª–∏ ‚Äî –¥–æ–±–∞–≤–∏—Ç—å —Ç–µ–∫—Å—Ç –≤ ContextManager.predefined_roles
- –§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–æ–≤:
  - –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é ParseMode.MARKDOWN. –ò–∑–±–µ–≥–∞—Ç—å —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª–æ–≤ Markdown V2; –ø—Ä–∏ —Å–æ–º–Ω–µ–Ω–∏–∏ —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞—Ç—å
  - –ß–∏—Å—Ç–∏—Ç–µ —Ä–µ–∫–ª–∞–º–Ω—ã–µ –≤—Å—Ç–∞–≤–∫–∏ –∏–∑ AI-–æ—Ç–≤–µ—Ç–æ–≤ strip_advertisement
- –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π:
  - –®–∏—Ä–∏–Ω–∞/–≤—ã—Å–æ—Ç–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω—ã 256..1536; seed –æ–ø—Ü–∏–æ–Ω–∞–ª–µ–Ω
  - –î–µ—Ä–∂–∏—Ç–µ callback_data –∫–æ—Ä–æ—Ç–∫–∏–º (–Ω–∞–ø—Ä–∏–º–µ—Ä, imagine::1024x1024)
- –ö–æ–Ω—Ç–µ–∫—Å—Ç –∏ –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—å:
  - –°–æ—Ö—Ä–∞–Ω—è–π—Ç–µ —Ç–æ–ª—å–∫–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ–µ; –∫–æ–Ω—Ç–µ–∫—Å—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω –ª–∏–º–∏—Ç–æ–º (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é settings.context_limit)
- –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:
  - –ù–æ–≤—ã–µ –ø–æ–ª—è –¥–æ–±–∞–≤–ª—è—Ç—å –≤ Settings c –≤–∞–ª–∏–¥–∞—Ç–æ—Ä–∞–º–∏ –∏ .env.example; –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å settings ÔøΩÔøΩ –∫–æ–¥–µ
